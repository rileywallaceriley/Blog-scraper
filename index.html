<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REWRITE — Hip Hop News</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
background-color: #0a0a0a;
color: #f0ece4;
font-family: ‘DM Sans’, sans-serif;
min-height: 100vh;
}

header {
background-color: #0a0a0a;
border-bottom: 1px solid #2a2a2a;
padding: 0 20px;
display: flex;
align-items: center;
justify-content: space-between;
height: 60px;
position: sticky;
top: 0;
z-index: 100;
}

.logo {
font-family: ‘Bebas Neue’, sans-serif;
font-size: 1.8rem;
letter-spacing: 4px;
color: #f0ece4;
}
.logo span { color: #ff3c00; }

.api-key-wrap {
display: flex;
align-items: center;
gap: 8px;
background-color: #111111;
border: 1px solid #2a2a2a;
border-radius: 4px;
padding: 6px 10px;
}
.api-key-wrap label {
font-family: ‘Space Mono’, monospace;
font-size: 0.55rem;
color: #666666;
text-transform: uppercase;
letter-spacing: 2px;
white-space: nowrap;
}
.api-key-wrap input {
background: none;
border: none;
outline: none;
color: #00ff88;
font-family: ‘Space Mono’, monospace;
font-size: 0.7rem;
width: 150px;
}
.api-key-wrap input::placeholder { color: #2a2a2a; }

.ticker {
background-color: #ff3c00;
padding: 5px 0;
overflow: hidden;
white-space: nowrap;
}
.ticker-inner {
display: inline-block;
animation: ticker 40s linear infinite;
font-family: ‘Space Mono’, monospace;
font-size: 0.65rem;
letter-spacing: 3px;
color: #000000;
font-weight: 700;
}
@keyframes ticker {
from { transform: translateX(100vw); }
to { transform: translateX(-100%); }
}

.container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

.controls {
display: flex;
flex-direction: column;
gap: 14px;
margin-bottom: 20px;
}

.source-chips { display: flex; gap: 8px; flex-wrap: wrap; }

.chip {
font-family: ‘Space Mono’, monospace;
font-size: 0.6rem;
letter-spacing: 1px;
padding: 7px 14px;
border: 1px solid #2a2a2a;
border-radius: 2px;
cursor: pointer;
background-color: #0a0a0a;
color: #666666;
text-transform: uppercase;
transition: all 0.15s;
}
.chip.active { border-color: #ff3c00; color: #ff3c00; background-color: #1a0a05; }

.controls-row {
display: flex;
gap: 10px;
align-items: center;
flex-wrap: wrap;
}

.style-select {
font-family: ‘Space Mono’, monospace;
font-size: 0.65rem;
background-color: #111111;
border: 1px solid #2a2a2a;
color: #f0ece4;
padding: 8px 12px;
border-radius: 2px;
cursor: pointer;
letter-spacing: 1px;
flex: 1;
}

.btn {
font-family: ‘Bebas Neue’, sans-serif;
letter-spacing: 3px;
font-size: 1rem;
padding: 10px 24px;
cursor: pointer;
border: none;
border-radius: 2px;
transition: all 0.15s;
white-space: nowrap;
}
.btn-primary { background-color: #ff3c00; color: #ffffff; }
.btn-primary:hover { background-color: #ff5500; }
.btn-primary:disabled { background-color: #2a2a2a; color: #444444; cursor: not-allowed; }

.debug-log {
background-color: #111111;
border: 1px solid #2a2a2a;
border-radius: 2px;
padding: 10px 14px;
margin-bottom: 16px;
font-family: ‘Space Mono’, monospace;
font-size: 0.6rem;
color: #666666;
letter-spacing: 1px;
max-height: 70px;
overflow-y: auto;
display: none;
}
.debug-log.visible { display: block; }
.debug-log p { line-height: 1.9; }
.debug-log p.ok { color: #00ff88; }
.debug-log p.err { color: #ff3c00; }

.rewrite-bar {
display: flex;
align-items: center;
justify-content: space-between;
background-color: #111111;
border: 1px solid #2a2a2a;
border-radius: 2px;
padding: 12px 16px;
margin-bottom: 16px;
gap: 12px;
}
.rewrite-bar p {
font-family: ‘Space Mono’, monospace;
font-size: 0.65rem;
color: #666666;
letter-spacing: 1px;
}
.progress-bar-wrap {
height: 2px;
background-color: #2a2a2a;
border-radius: 2px;
margin-top: 6px;
overflow: hidden;
width: 120px;
}
.progress-bar-fill {
height: 100%;
background-color: #ff3c00;
width: 0%;
transition: width 0.3s;
}

.stories-grid {
display: grid;
grid-template-columns: 1fr;
gap: 1px;
background-color: #2a2a2a;
border: 1px solid #2a2a2a;
}
@media(min-width: 700px) {
.stories-grid { grid-template-columns: repeat(2, 1fr); }
}
@media(min-width: 1100px) {
.stories-grid { grid-template-columns: repeat(3, 1fr); }
}

.story-card {
background-color: #0a0a0a;
padding: 22px;
display: flex;
flex-direction: column;
gap: 12px;
position: relative;
overflow: hidden;
}
.story-card::before {
content: ‘’;
position: absolute;
top: 0; left: 0;
width: 3px; height: 0;
background-color: #ff3c00;
transition: height 0.3s;
}
.story-card:hover { background-color: #111111; }
.story-card:hover::before { height: 100%; }

.card-meta { display: flex; justify-content: space-between; align-items: center; }

.source-tag {
font-family: ‘Space Mono’, monospace;
font-size: 0.55rem;
letter-spacing: 2px;
color: #ff3c00;
text-transform: uppercase;
background-color: #1a0a05;
padding: 3px 7px;
border-radius: 1px;
}
.pub-date {
font-family: ‘Space Mono’, monospace;
font-size: 0.55rem;
color: #444444;
}

.card-title {
font-family: ‘Bebas Neue’, sans-serif;
font-size: 1.4rem;
letter-spacing: 1px;
line-height: 1.1;
color: #f0ece4;
}

.card-original {
font-size: 0.8rem;
line-height: 1.6;
color: #555555;
border-left: 2px solid #2a2a2a;
padding-left: 10px;
font-style: italic;
display: -webkit-box;
-webkit-line-clamp: 3;
-webkit-box-orient: vertical;
overflow: hidden;
}

.card-rewritten {
font-size: 0.88rem;
line-height: 1.65;
color: #f0ece4;
background-color: #0f0f08;
border: 1px solid #2a2400;
border-radius: 2px;
padding: 12px;
}
.rewrite-label {
font-family: ‘Space Mono’, monospace;
font-size: 0.52rem;
letter-spacing: 3px;
text-transform: uppercase;
color: #ffd600;
margin-bottom: 8px;
display: block;
}

.card-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

.btn-sm {
font-family: ‘Space Mono’, monospace;
font-size: 0.58rem;
letter-spacing: 1px;
padding: 6px 12px;
border: 1px solid #2a2a2a;
border-radius: 2px;
cursor: pointer;
background: none;
color: #666666;
text-transform: uppercase;
transition: all 0.15s;
}
.btn-sm:hover { border-color: #ff3c00; color: #ff3c00; }
.btn-sm.rewrite-btn { border-color: #ff3c00; color: #ff3c00; }
.btn-sm.rewrite-btn:hover { background-color: #ff3c00; color: #ffffff; }
.btn-sm.rewrite-btn:disabled { border-color: #2a2a2a; color: #333333; cursor: not-allowed; }

.original-link {
font-family: ‘Space Mono’, monospace;
font-size: 0.58rem;
letter-spacing: 1px;
color: #444444;
text-decoration: none;
margin-left: auto;
transition: color 0.15s;
}
.original-link:hover { color: #f0ece4; }

.spinner {
width: 14px; height: 14px;
border: 2px solid #2a2a2a;
border-top-color: #ff3c00;
border-radius: 50%;
animation: spin 0.7s linear infinite;
display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }

.status-msg {
grid-column: 1 / -1;
padding: 60px 30px;
text-align: center;
font-family: ‘Space Mono’, monospace;
font-size: 0.75rem;
color: #444444;
letter-spacing: 2px;
background-color: #0a0a0a;
}
.big-status {
font-family: ‘Bebas Neue’, sans-serif;
font-size: 3.5rem;
color: #1a1a1a;
letter-spacing: 8px;
display: block;
margin-bottom: 12px;
}

.toast {
position: fixed;
bottom: 24px;
right: 20px;
left: 20px;
background-color: #111111;
border: 1px solid #2a2a2a;
border-left: 3px solid #00ff88;
padding: 12px 16px;
font-family: ‘Space Mono’, monospace;
font-size: 0.65rem;
letter-spacing: 1px;
color: #f0ece4;
border-radius: 2px;
transform: translateY(120px);
opacity: 0;
transition: all 0.3s ease;
z-index: 1000;
}
@media(min-width: 500px) {
.toast { left: auto; width: 280px; }
}
.toast.show { transform: translateY(0); opacity: 1; }
</style>

</head>
<body>

<header>
  <div class="logo">RE<span>WRITE</span></div>
  <div class="api-key-wrap">
    <label>OpenAI Key</label>
    <input type="password" id="apiKey" placeholder="sk-..." autocomplete="off">
  </div>
</header>

<div class="ticker">
  <span class="ticker-inner">★ REWRITE — AI-POWERED HIP HOP NEWS ★ LATEST STORIES FROM ACROSS THE CULTURE ★ POWERED BY OPENAI ★ REWRITE — AI-POWERED HIP HOP NEWS ★ LATEST STORIES FROM ACROSS THE CULTURE ★ POWERED BY OPENAI ★</span>
</div>

<div class="container">
  <div class="controls">
    <div class="source-chips" id="sourceChips">
      <button class="chip active" data-name="HipHopDX"     data-url="https://hiphopdx.com/rss">HipHopDX</button>
      <button class="chip active" data-name="AllHipHop"    data-url="https://allhiphop.com/feed">AllHipHop</button>
      <button class="chip active" data-name="The Source"   data-url="https://thesource.com/feed">The Source</button>
      <button class="chip active" data-name="Complex"      data-url="https://www.complex.com/music/rss">Complex</button>
      <button class="chip active" data-name="HotNewHipHop" data-url="https://www.hotnewhiphop.com/rss/news.rss">HotNewHipHop</button>
      <button class="chip"        data-name="TMZ HipHop"   data-url="https://www.tmz.com/category/hip-hop/rss.xml">TMZ HipHop</button>
      <button class="chip"        data-name="XXL"          data-url="https://xxlmag.com/feed">XXL</button>
      <button class="chip"        data-name="Pitchfork"    data-url="https://pitchfork.com/feed/feed-news/rss">Pitchfork</button>
    </div>

```
<div class="controls-row">
  <select class="style-select" id="styleSelect">
    <option value="street reporter">Street Reporter</option>
    <option value="hype man">Hype Man</option>
    <option value="scholarly hip hop academic">Academic</option>
    <option value="old school hip hop head">Old School Head</option>
    <option value="Gen Z rap fan">Gen Z Fan</option>
    <option value="neutral journalist">Neutral Journalist</option>
  </select>
  <button class="btn btn-primary" id="fetchBtn">FETCH STORIES</button>
</div>
```

  </div>

  <div class="debug-log" id="debugLog"></div>

  <div id="rewriteBar" class="rewrite-bar" style="display:none">
    <div>
      <p id="rewriteBarText">0 of 0 stories rewritten</p>
      <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressFill"></div></div>
    </div>
    <button class="btn btn-primary" id="rewriteAllBtn">REWRITE ALL</button>
  </div>

  <div class="stories-grid" id="storiesGrid">
    <div class="status-msg">
      <span class="big-status">FEED</span>
      Select your sources and hit FETCH STORIES
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let stories = [];

const PROXIES = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

document.querySelectorAll('.chip').forEach(c => c.addEventListener('click', () => c.classList.toggle('active')));

function log(msg, type) {
  const el = document.getElementById('debugLog');
  el.classList.add('visible');
  const p = document.createElement('p');
  if (type) p.className = type;
  p.textContent = '› ' + msg;
  el.appendChild(p);
  el.scrollTop = el.scrollHeight;
}

async function fetchWithProxy(url) {
  for (let i = 0; i < PROXIES.length; i++) {
    try {
      log('Trying proxy ' + (i+1) + ' for ' + new URL(url).hostname + '...');
      const res = await fetch(PROXIES[i](url), { signal: AbortSignal.timeout(9000) });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      try { const j = JSON.parse(text); if (j.contents) return j.contents; } catch(e) {}
      return text;
    } catch(e) {
      log('Proxy ' + (i+1) + ' failed: ' + e.message, 'err');
    }
  }
  throw new Error('All proxies failed');
}

function parseRSS(xmlStr, sourceName) {
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlStr, 'text/xml');
  const results = [];
  xml.querySelectorAll('item').forEach(function(item, i) {
    if (i >= 8) return;
    function getText(tag) { return (item.querySelector(tag) || {}).textContent || ''; }
    const title = getText('title').replace(/<!\[CDATA\[|\]\]>/g,'').trim() || 'Untitled';
    const link  = getText('link').trim() || '#';
    const desc  = getText('description').replace(/<!\[CDATA\[|\]\]>/g,'').trim();
    const pubDate = getText('pubDate').trim();
    const div = document.createElement('div');
    div.innerHTML = desc;
    const clean = (div.textContent || '').slice(0,600).trim();
    if (!title || title === 'Untitled') return;
    results.push({ title: title, link: link, description: clean, pubDate: pubDate, source: sourceName, rewritten: null });
  });
  return results;
}

document.getElementById('fetchBtn').addEventListener('click', async function() {
  const active = Array.from(document.querySelectorAll('.chip.active'));
  if (!active.length) { showToast('Select at least one source!'); return; }

  const btn = document.getElementById('fetchBtn');
  btn.disabled = true; btn.textContent = 'FETCHING...';
  document.getElementById('debugLog').innerHTML = '';

  const grid = document.getElementById('storiesGrid');
  grid.innerHTML = '<div class="status-msg"><span class="spinner"></span><br><br>Pulling stories from the culture...</div>';
  stories = [];

  for (let i = 0; i < active.length; i++) {
    const chip = active[i];
    try {
      const xml = await fetchWithProxy(chip.dataset.url);
      const parsed = parseRSS(xml, chip.dataset.name);
      log(chip.dataset.name + ': ' + parsed.length + ' stories', parsed.length ? 'ok' : 'err');
      stories = stories.concat(parsed);
    } catch(e) {
      log(chip.dataset.name + ': FAILED — ' + e.message, 'err');
    }
  }

  stories.sort(function() { return Math.random() - 0.5; });
  btn.disabled = false; btn.textContent = 'FETCH STORIES';

  if (!stories.length) {
    grid.innerHTML = '<div class="status-msg"><span class="big-status">404</span>No stories loaded. Check the debug log above.</div>';
    return;
  }

  renderStories();
  document.getElementById('rewriteBar').style.display = 'flex';
  updateProgress();
});

function renderStories() {
  const grid = document.getElementById('storiesGrid');
  grid.innerHTML = '';
  stories.forEach(function(s, i) { grid.appendChild(createCard(s, i)); });
}

function createCard(story, idx) {
  const card = document.createElement('div');
  card.className = 'story-card';
  card.id = 'card-' + idx;
  const dateStr = story.pubDate ? new Date(story.pubDate).toLocaleDateString('en-US', { month:'short', day:'numeric' }) : '';
  const rewrittenHtml = story.rewritten
    ? '<div class="card-rewritten"><span class="rewrite-label">✦ AI Rewrite</span>' + story.rewritten + '</div>'
    : '';
  const copyBtn = story.rewritten ? '<button class="btn-sm" onclick="copyText(' + idx + ')">COPY</button>' : '';
  card.innerHTML =
    '<div class="card-meta">' +
      '<span class="source-tag">' + story.source + '</span>' +
      '<span class="pub-date">' + dateStr + '</span>' +
    '</div>' +
    '<div class="card-title">' + story.title + '</div>' +
    (story.description ? '<div class="card-original">' + story.description + '</div>' : '') +
    rewrittenHtml +
    '<div class="card-actions">' +
      '<button class="btn-sm rewrite-btn" id="rbtn-' + idx + '" onclick="rewriteSingle(' + idx + ')">' +
        (story.rewritten ? 'REWRITE AGAIN' : 'REWRITE') +
      '</button>' +
      copyBtn +
      '<a class="original-link" href="' + story.link + '" target="_blank">&#8599; ORIGINAL</a>' +
    '</div>';
  return card;
}

function updateCard(idx) {
  const el = document.getElementById('card-' + idx);
  if (el) el.replaceWith(createCard(stories[idx], idx));
}

async function rewriteSingle(idx) {
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { showToast('Add your OpenAI key!'); return; }
  const btn = document.getElementById('rbtn-' + idx);
  if (btn) { btn.disabled = true; btn.textContent = 'WRITING...'; }
  try {
    stories[idx].rewritten = await callOpenAI(key, stories[idx]);
    updateCard(idx); updateProgress(); showToast('Story rewritten ✓');
  } catch(e) {
    showToast('Error: ' + e.message);
    if (btn) { btn.disabled = false; btn.textContent = 'REWRITE'; }
  }
}

async function callOpenAI(apiKey, story) {
  const style = document.getElementById('styleSelect').value;
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
    body: JSON.stringify({
      model: 'gpt-4o',
      max_tokens: 400,
      messages: [
        { role: 'system', content: 'You are a hip hop culture writer with the voice of a ' + style + '. Write punchy, factual rewrites around 150 words. Never start with "Here is..." — jump straight in.' },
        { role: 'user', content: 'Rewrite this hip hop news story:\n\nTitle: ' + story.title + '\n\nOriginal: ' + (story.description || '(no description — use the title)') }
      ]
    })
  });
  if (!res.ok) {
    const e = await res.json().catch(function() { return {}; });
    throw new Error((e.error && e.error.message) || 'HTTP ' + res.status);
  }
  const data = await res.json();
  return data.choices[0].message.content.trim();
}

document.getElementById('rewriteAllBtn').addEventListener('click', async function() {
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { showToast('Add your OpenAI key!'); return; }
  const btn = document.getElementById('rewriteAllBtn');
  btn.disabled = true; btn.textContent = 'RUNNING...';
  for (let i = 0; i < stories.length; i++) {
    if (stories[i].rewritten) continue;
    try {
      stories[i].rewritten = await callOpenAI(key, stories[i]);
      updateCard(i); updateProgress();
      await new Promise(function(r) { setTimeout(r, 400); });
    } catch(e) {
      showToast('Stopped at story ' + (i+1) + ': ' + e.message);
      break;
    }
  }
  btn.disabled = false; btn.textContent = 'REWRITE ALL';
  showToast('All done! ✦');
});

function updateProgress() {
  const done = stories.filter(function(s) { return s.rewritten; }).length;
  const total = stories.length;
  document.getElementById('rewriteBarText').textContent = done + ' of ' + total + ' stories rewritten';
  document.getElementById('progressFill').style.width = total ? ((done/total)*100) + '%' : '0%';
}

function copyText(idx) {
  const s = stories[idx];
  navigator.clipboard.writeText(s.title + '\n\n' + s.rewritten + '\n\nOriginal: ' + s.link).then(function() { showToast('Copied!'); });
}

let toastTimeout;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(function() { t.classList.remove('show'); }, 3500);
}
</script>

</body>
</html>